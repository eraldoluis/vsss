<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>The PG Library: /Users/daa/legacy/src/libpg/trunk/simulators/SP38/SP38Simulation.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.3 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Namespaces</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
  </ul>
</div>
<h1>/Users/daa/legacy/src/libpg/trunk/simulators/SP38/SP38Simulation.cc</h1><a href="_s_p38_simulation_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include "<a class="code" href="_s_p38_simulation_8hh.html">SP38Simulation.hh</a>"</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="keyword">namespace </span>SP38 {
<a name="l00004"></a>00004 
<a name="l00017"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#4eab5ef7b68135e5b97336fcdbffbb38">00017</a>   <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#4eab5ef7b68135e5b97336fcdbffbb38">SP38Simulation::SP38Simulation</a>(<a class="code" href="namespace_s_p38.html#4c161ad2519b50be4dd00dc33621322b">uint</a> <a class="code" href="namespacesum_and_plot.html#603763aecd0551b8cd9fc4892c55fd3f">s</a>, <a class="code" href="class_s_p38_1_1_scenario_reader.html">ScenarioReader</a>* sr,<span class="keywordtype">string</span> host, <span class="keywordtype">bool</span> fapc, <span class="keywordtype">bool</span> f, <span class="keywordtype">bool</span> d, <span class="keywordtype">bool</span> n, <span class="keywordtype">int</span> maxt, <span class="keywordtype">bool</span> <span class="keywordtype">id</span>) 
<a name="l00018"></a>00018     : time_step_size(s), current_time(0), last_restart_time(0), force_all_phases_constraint(fapc), run_forever(f), debug(d), noisy(n), max_tries(maxt) {
<a name="l00019"></a>00019     
<a name="l00020"></a>00020     scenario = sr-&gt;<a class="code" href="class_s_p38_1_1_scenario_reader.html#15a0cf44bed89009f94d14f5f7a02776">readScenario</a>();
<a name="l00021"></a>00021     scenario_history = <span class="keyword">new</span> <a class="code" href="class_s_p38_1_1_scenario_history.html">ScenarioHistory</a>(scenario,s);
<a name="l00022"></a>00022     assert(scenario != NULL);
<a name="l00023"></a>00023     sp38interface = <span class="keyword">new</span> <a class="code" href="class_s_p38_1_1_s_p38_interface.html">SP38Interface</a>(scenario,host);
<a name="l00024"></a>00024     sp38interface-&gt;<a class="code" href="class_s_p38_1_1_s_p38_interface.html#a9b672e65e2be3350793890160c51ea3">set_debug</a>(<span class="keywordtype">id</span>);
<a name="l00025"></a>00025     sp38interface-&gt;<a class="code" href="class_s_p38_1_1_s_p38_interface.html#a610135f8065bb490d4fa9662bc7c911">set_noisy</a>(<span class="keywordtype">id</span>);
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 
<a name="l00028"></a>00028   }
<a name="l00029"></a>00029   
<a name="l00033"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#d5cc85248a1922986d684f89c4a72814">00033</a>   <span class="keywordtype">void</span> SP38Simulation::startSimulation(){
<a name="l00034"></a>00034 
<a name="l00035"></a>00035     <span class="keywordtype">bool</span> connected = <span class="keyword">false</span>;
<a name="l00036"></a>00036     <span class="keywordtype">int</span> tries = 0;
<a name="l00037"></a>00037     <span class="keywordflow">while</span>(!connected &amp;&amp; tries &lt; max_tries){
<a name="l00038"></a>00038       <a class="code" href="_sleep_8hh.html#f1062a94b39469a3e3e758f47f063f62">Sleep</a>(1000); <span class="comment">// Wait 1 second until try to connect</span>
<a name="l00039"></a>00039       <span class="keywordflow">if</span>(noisy) cout &lt;&lt; <span class="stringliteral">"Trying to connect... "</span> &lt;&lt; tries + 1 &lt;&lt; endl;
<a name="l00040"></a>00040       <span class="keywordflow">try</span> {
<a name="l00041"></a>00041         sp38interface-&gt;<a class="code" href="class_s_p38_1_1_s_p38_interface.html#9f9c3c0dbe0c3df5cd69571be258b916">tryConnect</a>();
<a name="l00042"></a>00042         connected = <span class="keyword">true</span>;
<a name="l00043"></a>00043         <span class="keywordflow">if</span>(noisy) cout &lt;&lt; <span class="stringliteral">"CONNECTED"</span> &lt;&lt; endl;
<a name="l00044"></a>00044       }<span class="keywordflow">catch</span>(<a class="code" href="class_socket_exception.html">SocketException</a>&amp;){
<a name="l00045"></a>00045         <span class="keywordflow">if</span>(noisy) cout &lt;&lt; <span class="stringliteral">"Connection failed"</span> &lt;&lt; endl;  
<a name="l00046"></a>00046         tries++;
<a name="l00047"></a>00047       }
<a name="l00048"></a>00048     }
<a name="l00049"></a>00049 
<a name="l00050"></a>00050     <span class="keywordflow">if</span>(tries == max_tries){
<a name="l00051"></a>00051       <span class="keywordflow">if</span>(noisy) cout &lt;&lt; <span class="stringliteral">"Maximum tries exceeded. exiting."</span> &lt;&lt; endl;
<a name="l00052"></a>00052       exit(0);
<a name="l00053"></a>00053     }
<a name="l00054"></a>00054     
<a name="l00055"></a>00055     <span class="comment">/* Refreshing the current date time */</span>
<a name="l00056"></a>00056     setCurrentDateTime(sp38interface-&gt;<a class="code" href="class_s_p38_1_1_s_p38_interface.html#31c28bbf1adb44b873fb4d7ec76d6042">getStartDate</a>(),sp38interface-&gt;<a class="code" href="class_s_p38_1_1_s_p38_interface.html#373bfc1e1de052fb957bd46674b4e800">getStartTime</a>());
<a name="l00057"></a>00057 
<a name="l00058"></a>00058     <span class="comment">/* Doing first Step */</span>
<a name="l00059"></a>00059     <span class="keywordflow">for</span>(IntersectionSet::iterator <a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a> = scenario-&gt;<a class="code" href="class_s_p38_1_1_scenario.html#ce4f52834a02f040f43167ae7a6f3f2e">intersections</a>.begin(); <a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a> != scenario-&gt;<a class="code" href="class_s_p38_1_1_scenario.html#ce4f52834a02f040f43167ae7a6f3f2e">intersections</a>.end(); <a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a>++){
<a name="l00060"></a>00060       <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#b30c5ee524996b7d5bb890adf930f0a1">setNewPhase</a>(*<a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a>,(*i)-&gt;getStartPhase());
<a name="l00061"></a>00061     }
<a name="l00062"></a>00062     <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#3bad89311b1f00f40f9617e7bde21f3d">doStep</a>();    
<a name="l00063"></a>00063   }
<a name="l00064"></a>00064 
<a name="l00071"></a>00071   <span class="keywordtype">void</span> SP38Simulation::setCurrentDateTime(<span class="keywordtype">string</span> date, <span class="keywordtype">string</span> time){
<a name="l00072"></a>00072     current_date_time = boost::posix_time::ptime(boost::posix_time::from_iso_string(date+<span class="stringliteral">"T"</span>+time));
<a name="l00073"></a>00073   }
<a name="l00074"></a>00074 
<a name="l00075"></a>00075   
<a name="l00079"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#3bad89311b1f00f40f9617e7bde21f3d">00079</a>   <span class="keywordtype">void</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#3bad89311b1f00f40f9617e7bde21f3d">SP38Simulation::doStep</a>(){
<a name="l00080"></a>00080 
<a name="l00081"></a>00081     <span class="keywordtype">int</span> finish = current_time + <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#f0158583ef8e6419f47dd2fa991caa1c">getTimeStepSize</a>();
<a name="l00082"></a>00082 
<a name="l00083"></a>00083     <span class="comment">// Doing a number of steps without actions</span>
<a name="l00084"></a>00084     <span class="keywordflow">while</span>(current_time != finish &amp;&amp; <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#dcefdf577a68866780a272b5f015d4bc">simulating</a>()){
<a name="l00085"></a>00085       <span class="comment">//Gets the schedule</span>
<a name="l00086"></a>00086       <a class="code" href="namespace_s_p38.html#9a0b9534bc4e34b3bf4bcf849e6849d3">ScheduleSet</a> current_schedule = getCurrentSchedule(current_time);
<a name="l00087"></a>00087       <span class="comment">//Send the actions and receive the events</span>
<a name="l00088"></a>00088       <a class="code" href="namespace_s_p38.html#c4c9a0677ba5f336332244bccf46fd2b">EventSet</a> resulted_events = sp38interface-&gt;<a class="code" href="class_s_p38_1_1_s_p38_interface.html#15d237a0af85c01f840ed274e2369ae8">do_step</a>(current_schedule);
<a name="l00089"></a>00089       <span class="comment">//Refresh the history with the events</span>
<a name="l00090"></a>00090       processEvents(resulted_events); 
<a name="l00091"></a>00091       <span class="comment">//Clean the sets</span>
<a name="l00092"></a>00092       clearScheduleSet(current_schedule);
<a name="l00093"></a>00093       clearEventSet(resulted_events);
<a name="l00094"></a>00094       <span class="comment">//Refresh the current time for the simulator andhistory</span>
<a name="l00095"></a>00095       increaseCurrentTime();
<a name="l00096"></a>00096       scenario_history-&gt;<a class="code" href="class_s_p38_1_1_scenario_history.html#3db24f53adfdbfc9d8676136eb27e42e">setCurrentTime</a>(current_time);
<a name="l00097"></a>00097     }
<a name="l00098"></a>00098 
<a name="l00099"></a>00099     <span class="comment">//Force the satisfaction of constraints</span>
<a name="l00100"></a>00100     <span class="keywordflow">if</span>(<a class="code" href="class_s_p38_1_1_s_p38_simulation.html#dcefdf577a68866780a272b5f015d4bc">simulating</a>() &amp;&amp; force_all_phases_constraint ) forceAllPhasesInCycleConstraint();
<a name="l00101"></a>00101 
<a name="l00102"></a>00102     <span class="comment">// If simulation ended, must restart</span>
<a name="l00103"></a>00103     <span class="keywordflow">if</span>(run_forever &amp;&amp; !<a class="code" href="class_s_p38_1_1_s_p38_simulation.html#dcefdf577a68866780a272b5f015d4bc">simulating</a>()){
<a name="l00104"></a>00104       <span class="comment">//sends current time to next cycle! (Or it can mess with scenario history)</span>
<a name="l00105"></a>00105       <span class="keywordtype">int</span> ccd = <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#ccaefdff0b3a68d524cb19bad46dc507">getCurrentCycleDuration</a>();
<a name="l00106"></a>00106       <span class="keywordtype">int</span> cd = scenario-&gt;<a class="code" href="class_s_p38_1_1_scenario.html#975956fd39c891d3bee9e9fbec1630ba">getCycleDuration</a>();
<a name="l00107"></a>00107       current_time += cd - ccd;
<a name="l00108"></a>00108       <span class="comment">//Cleans schedule</span>
<a name="l00109"></a>00109       schedule.clear();
<a name="l00110"></a>00110       <span class="comment">// Restarted in...</span>
<a name="l00111"></a>00111       last_restart_time = current_time;
<a name="l00112"></a>00112       <span class="comment">//Set initial state</span>
<a name="l00113"></a>00113       scenario_history-&gt;<a class="code" href="class_s_p38_1_1_scenario_history.html#3db24f53adfdbfc9d8676136eb27e42e">setCurrentTime</a>(current_time);
<a name="l00114"></a>00114       scenario_history-&gt;<a class="code" href="class_s_p38_1_1_scenario_history.html#1edfe6707d78c152261edeb47cbd581a">setInitialState</a>();
<a name="l00115"></a>00115       <span class="comment">//Start simulation again</span>
<a name="l00116"></a>00116       <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#d5cc85248a1922986d684f89c4a72814">startSimulation</a>();
<a name="l00117"></a>00117     }
<a name="l00118"></a>00118     
<a name="l00119"></a>00119   }
<a name="l00120"></a>00120 
<a name="l00124"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#1da9d2dabd3374330564f6d7df6af9a9">00124</a>   <span class="keywordtype">int</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#1da9d2dabd3374330564f6d7df6af9a9">SP38Simulation::getDayHour</a>(){
<a name="l00125"></a>00125     <span class="keywordflow">return</span> current_date_time.time_of_day().hours();
<a name="l00126"></a>00126   }
<a name="l00127"></a>00127 
<a name="l00131"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#747ea44d608321d860a6f0f382ede2fa">00131</a>   <span class="keywordtype">int</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#747ea44d608321d860a6f0f382ede2fa">SP38Simulation::getDayHourMinute</a>(){
<a name="l00132"></a>00132     <span class="keywordflow">return</span> current_date_time.time_of_day().minutes();
<a name="l00133"></a>00133   }
<a name="l00134"></a>00134   
<a name="l00135"></a>00135 
<a name="l00141"></a>00141   <span class="keywordtype">void</span> SP38Simulation::increaseCurrentTime(){
<a name="l00142"></a>00142     current_time++;
<a name="l00143"></a>00143     current_date_time += boost::posix_time::seconds(1);
<a name="l00144"></a>00144   }
<a name="l00145"></a>00145 
<a name="l00146"></a>00146   
<a name="l00150"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#d8b0c78b95ea581ac99dd2b5bbbb1c50">00150</a>   <span class="keywordtype">void</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#d8b0c78b95ea581ac99dd2b5bbbb1c50">SP38Simulation::endSimulation</a>(){
<a name="l00151"></a>00151     sp38interface-&gt;<a class="code" href="class_s_p38_1_1_s_p38_interface.html#17729215bb45bb476fdb7aa26c8f72e8">disconnect</a>();
<a name="l00152"></a>00152     <span class="keywordflow">if</span>(noisy){
<a name="l00153"></a>00153       cout &lt;&lt; <span class="stringliteral">" *** CARS! *** "</span> &lt;&lt; endl;
<a name="l00154"></a>00154       <span class="keywordtype">int</span> total_net = 0;
<a name="l00155"></a>00155       <span class="keywordflow">for</span>(IntersectionSet::iterator <a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a> = scenario-&gt;<a class="code" href="class_s_p38_1_1_scenario.html#ce4f52834a02f040f43167ae7a6f3f2e">intersections</a>.begin(); <a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a> != scenario-&gt;<a class="code" href="class_s_p38_1_1_scenario.html#ce4f52834a02f040f43167ae7a6f3f2e">intersections</a>.end(); <a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a>++){
<a name="l00156"></a>00156         cout &lt;&lt; <span class="stringliteral">"\t Intersection "</span> &lt;&lt; (*i)-&gt;getScatsId() &lt;&lt; endl;
<a name="l00157"></a>00157         <span class="keywordtype">int</span> total_int = 0;
<a name="l00158"></a>00158         <span class="keywordflow">for</span>(DetectorSet::iterator d = (*i)-&gt;detectors.begin(); d != (*i)-&gt;detectors.end(); d++){        
<a name="l00159"></a>00159           <span class="keywordtype">int</span> total_det = <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#dc5266cb2f5f693170fecaf324fa84ce">getDetectorCountBetween</a>(*<a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a>,*d,0.0,(<span class="keywordtype">double</span>)current_time);
<a name="l00160"></a>00160         cout &lt;&lt; <span class="stringliteral">"\t\t Detector "</span> &lt;&lt; (*d)-&gt;getScatsId() &lt;&lt; <span class="stringliteral">" Total Cars "</span> &lt;&lt; total_det &lt;&lt; endl;
<a name="l00161"></a>00161         total_int += total_det; 
<a name="l00162"></a>00162         }
<a name="l00163"></a>00163         cout &lt;&lt; <span class="stringliteral">"\t Intersection CARS: "</span> &lt;&lt; total_int &lt;&lt; endl;
<a name="l00164"></a>00164         cout &lt;&lt; endl;
<a name="l00165"></a>00165         total_net += total_int;
<a name="l00166"></a>00166       }
<a name="l00167"></a>00167       cout &lt;&lt; endl;
<a name="l00168"></a>00168       cout &lt;&lt; <span class="stringliteral">" TOTAL CARS: "</span> &lt;&lt; total_net &lt;&lt; endl;
<a name="l00169"></a>00169     }
<a name="l00170"></a>00170 
<a name="l00171"></a>00171     <span class="keywordflow">if</span>(run_forever){
<a name="l00172"></a>00172       <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#d5cc85248a1922986d684f89c4a72814">startSimulation</a>();
<a name="l00173"></a>00173     }
<a name="l00174"></a>00174   }
<a name="l00175"></a>00175 
<a name="l00179"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#dcefdf577a68866780a272b5f015d4bc">00179</a>   <span class="keywordtype">bool</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#dcefdf577a68866780a272b5f015d4bc">SP38Simulation::simulating</a>(){
<a name="l00180"></a>00180     <span class="keywordflow">return</span> sp38interface-&gt;<a class="code" href="class_s_p38_1_1_s_p38_interface.html#71a1c53cc731dcb7dc72d102863fdc8e">is_simulation_running</a>();
<a name="l00181"></a>00181   }
<a name="l00182"></a>00182   
<a name="l00187"></a>00187   <span class="keywordtype">void</span> SP38Simulation::processEvents(<a class="code" href="namespace_s_p38.html#c4c9a0677ba5f336332244bccf46fd2b">EventSet</a> es){
<a name="l00188"></a>00188     <span class="comment">// Processing detector events</span>
<a name="l00189"></a>00189     <span class="keywordflow">for</span>(EventSet::iterator esi = es.begin(); esi != es.end(); esi++){
<a name="l00190"></a>00190 
<a name="l00191"></a>00191       <a class="code" href="class_s_p38_1_1_intersection_history.html">IntersectionHistory</a>* ih = scenario_history-&gt;<a class="code" href="class_s_p38_1_1_scenario_history.html#b4f71a36ad11805bf324b7205b3bc283">getIntersectionHistory</a>( (*esi)-&gt;getIntersection() );  
<a name="l00192"></a>00192       <a class="code" href="namespace_s_p38.html#945f506f10ec320d5ca175d6624ecded">DetectorEventSet</a> des = (*esi)-&gt;getDetectorEventSet();
<a name="l00193"></a>00193 
<a name="l00194"></a>00194       <span class="keywordflow">for</span>(DetectorEventSet::iterator desi = des.begin(); desi != des.end(); desi++){
<a name="l00195"></a>00195         
<a name="l00196"></a>00196         <a class="code" href="class_s_p38_1_1_detector_history.html">DetectorHistory</a>* dh = ih-&gt;<a class="code" href="class_s_p38_1_1_intersection_history.html#4336b432932ce01a420be3a7c2d5b32b">getDetectorHistory</a>((*desi)-&gt;getDetector());
<a name="l00197"></a>00197 
<a name="l00198"></a>00198         <span class="comment">// Calculating the time of the event</span>
<a name="l00199"></a>00199         <span class="comment">// The duration is the offset in milliseconds</span>
<a name="l00200"></a>00200         <span class="comment">// orocessEvents is called before refreshing current time</span>
<a name="l00201"></a>00201         <span class="keywordtype">double</span> time = (double)current_time + ((<span class="keywordtype">double</span>)((*desi)-&gt;getDuration()))/1000 ;
<a name="l00202"></a>00202         <span class="keywordflow">if</span>((*desi)-&gt;wasActivated())
<a name="l00203"></a>00203           dh-&gt;<a class="code" href="class_s_p38_1_1_detector_history.html#c88ba13f9ba1d0fe4eeb1f9df6857343">activate</a>(time);
<a name="l00204"></a>00204         <span class="keywordflow">else</span>
<a name="l00205"></a>00205           dh-&gt;<a class="code" href="class_s_p38_1_1_detector_history.html#55d6388f5ff68abc219a6f86cfa34432">deactivate</a>(time);
<a name="l00206"></a>00206       
<a name="l00207"></a>00207       }
<a name="l00208"></a>00208     }
<a name="l00209"></a>00209 
<a name="l00210"></a>00210   }
<a name="l00211"></a>00211 
<a name="l00216"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#589873b1444c0555f0c282f0639d9378">00216</a>   <a class="code" href="class_s_p38_1_1_phase.html">Phase</a>* <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#589873b1444c0555f0c282f0639d9378">SP38Simulation::getCurrentPhase</a>(<a class="code" href="class_s_p38_1_1_intersection.html">Intersection</a>* <a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a>){
<a name="l00217"></a>00217     <a class="code" href="class_s_p38_1_1_intersection_history.html">IntersectionHistory</a>* ih = scenario_history-&gt;<a class="code" href="class_s_p38_1_1_scenario_history.html#b4f71a36ad11805bf324b7205b3bc283">getIntersectionHistory</a>(i);
<a name="l00218"></a>00218     <span class="keywordflow">return</span> ih-&gt;<a class="code" href="class_s_p38_1_1_intersection_history.html#107f09ff354e3f4403a05278e4261d93">getCurrentPhase</a>();    
<a name="l00219"></a>00219   }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221 
<a name="l00226"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#786460fe62ab4d3c0b104dab48968683">00226</a>   <span class="keywordtype">int</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#786460fe62ab4d3c0b104dab48968683">SP38Simulation::getCurrentPhaseDuration</a>(<a class="code" href="class_s_p38_1_1_intersection.html">Intersection</a>* <a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a>){
<a name="l00227"></a>00227     <a class="code" href="class_s_p38_1_1_intersection_history.html">IntersectionHistory</a>* ih = scenario_history-&gt;<a class="code" href="class_s_p38_1_1_scenario_history.html#b4f71a36ad11805bf324b7205b3bc283">getIntersectionHistory</a>(i);
<a name="l00228"></a>00228     <span class="keywordflow">return</span> ih-&gt;<a class="code" href="class_s_p38_1_1_intersection_history.html#918065eed29115d04142cf3c157e0bf5">getCurrentPhaseDuration</a>();
<a name="l00229"></a>00229   }
<a name="l00230"></a>00230 
<a name="l00236"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#c032f553bdc8713da36a01581e5e2f49">00236</a>   <span class="keywordtype">int</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#c032f553bdc8713da36a01581e5e2f49">SP38Simulation::getPhaseDurationInCurrentCycle</a>(<a class="code" href="class_s_p38_1_1_intersection.html">Intersection</a>* <a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a>, <a class="code" href="class_s_p38_1_1_phase.html">Phase</a>* p){
<a name="l00237"></a>00237 
<a name="l00238"></a>00238     <span class="keywordflow">return</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#1e58ac7a9a1b8fb5249f018516436705">getPhaseDurationBetween</a>(i,p,<a class="code" href="class_s_p38_1_1_s_p38_simulation.html#c4bbae7669b72caab73cb44c64db6ae5">getCurrentCycleStartingTime</a>(),current_time);
<a name="l00239"></a>00239   }
<a name="l00240"></a>00240 
<a name="l00248"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#1e58ac7a9a1b8fb5249f018516436705">00248</a>   <span class="keywordtype">int</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#1e58ac7a9a1b8fb5249f018516436705">SP38Simulation::getPhaseDurationBetween</a>(<a class="code" href="class_s_p38_1_1_intersection.html">Intersection</a>* <a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a>, <a class="code" href="class_s_p38_1_1_phase.html">Phase</a>* p, <span class="keywordtype">int</span> from, <span class="keywordtype">int</span> to){
<a name="l00249"></a>00249     <a class="code" href="class_s_p38_1_1_intersection_history.html">IntersectionHistory</a>* ih = scenario_history-&gt;<a class="code" href="class_s_p38_1_1_scenario_history.html#b4f71a36ad11805bf324b7205b3bc283">getIntersectionHistory</a>(i);
<a name="l00250"></a>00250     <a class="code" href="class_s_p38_1_1_phase_history.html">PhaseHistory</a>* ph = ih-&gt;<a class="code" href="class_s_p38_1_1_intersection_history.html#f7f89fcd6d2853b0e1dccd54d5f32ed7">getPhaseHistory</a>(p);
<a name="l00251"></a>00251     <span class="keywordflow">return</span> ph-&gt;<a class="code" href="class_s_p38_1_1_phase_history.html#5480cc74a7703c4676b8285449ae54b6">totalActiveTime</a>(from,to);
<a name="l00252"></a>00252   }
<a name="l00253"></a>00253 
<a name="l00259"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#1d3c8bf9a93713eb02d3cf6a787666d8">00259</a>   <span class="keywordtype">double</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#1d3c8bf9a93713eb02d3cf6a787666d8">SP38Simulation::getPhaseThroughputInCurrentCyle</a>(<a class="code" href="class_s_p38_1_1_intersection.html">Intersection</a>* <a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a>, <a class="code" href="class_s_p38_1_1_phase.html">Phase</a>* p){
<a name="l00260"></a>00260     <span class="keywordflow">return</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#dc853f2527c4c6b20267aab3f54bec45">getPhaseThroughputBetween</a>(i,p,<a class="code" href="class_s_p38_1_1_s_p38_simulation.html#c4bbae7669b72caab73cb44c64db6ae5">getCurrentCycleStartingTime</a>(),current_time);
<a name="l00261"></a>00261   }
<a name="l00262"></a>00262 
<a name="l00268"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#9cbc2edc6cc9b59c1041d4f67b2dd7f3">00268</a>   <span class="keywordtype">double</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#9cbc2edc6cc9b59c1041d4f67b2dd7f3">SP38Simulation::getPhaseThroughputInLastCompletedCyle</a>(<a class="code" href="class_s_p38_1_1_intersection.html">Intersection</a>* <a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a>, <a class="code" href="class_s_p38_1_1_phase.html">Phase</a>* p){
<a name="l00269"></a>00269     <span class="keywordflow">return</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#dc853f2527c4c6b20267aab3f54bec45">getPhaseThroughputBetween</a>(i,p,<a class="code" href="class_s_p38_1_1_s_p38_simulation.html#c4bbae7669b72caab73cb44c64db6ae5">getCurrentCycleStartingTime</a>()-scenario-&gt;<a class="code" href="class_s_p38_1_1_scenario.html#975956fd39c891d3bee9e9fbec1630ba">getCycleDuration</a>(),<a class="code" href="class_s_p38_1_1_s_p38_simulation.html#c4bbae7669b72caab73cb44c64db6ae5">getCurrentCycleStartingTime</a>());
<a name="l00270"></a>00270   }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272 
<a name="l00273"></a>00273 
<a name="l00281"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#dc853f2527c4c6b20267aab3f54bec45">00281</a>   <span class="keywordtype">double</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#dc853f2527c4c6b20267aab3f54bec45">SP38Simulation::getPhaseThroughputBetween</a>(<a class="code" href="class_s_p38_1_1_intersection.html">Intersection</a>* <a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a>, <a class="code" href="class_s_p38_1_1_phase.html">Phase</a>* p, <span class="keywordtype">int</span> from, <span class="keywordtype">int</span> to){
<a name="l00282"></a>00282     <a class="code" href="class_s_p38_1_1_intersection_history.html">IntersectionHistory</a>* ih = scenario_history-&gt;<a class="code" href="class_s_p38_1_1_scenario_history.html#b4f71a36ad11805bf324b7205b3bc283">getIntersectionHistory</a>(i);
<a name="l00283"></a>00283     <span class="keywordflow">return</span> ih-&gt;<a class="code" href="class_s_p38_1_1_intersection_history.html#5ae24171578262f7f5a36f2e7af0774e">getPhaseThroughputBetween</a>(p, from, to);
<a name="l00284"></a>00284   }
<a name="l00285"></a>00285 
<a name="l00293"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#bba0dfe6bf53eec9599da1221acbcfad">00293</a>   <span class="keywordtype">double</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#bba0dfe6bf53eec9599da1221acbcfad">SP38Simulation::getPhaseMaxDetectorThroughputBetween</a>(<a class="code" href="class_s_p38_1_1_intersection.html">Intersection</a>* <a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a>, <a class="code" href="class_s_p38_1_1_phase.html">Phase</a>* p, <span class="keywordtype">int</span> from, <span class="keywordtype">int</span> to){
<a name="l00294"></a>00294     <a class="code" href="class_s_p38_1_1_intersection_history.html">IntersectionHistory</a>* ih = scenario_history-&gt;<a class="code" href="class_s_p38_1_1_scenario_history.html#b4f71a36ad11805bf324b7205b3bc283">getIntersectionHistory</a>(i);
<a name="l00295"></a>00295     <span class="keywordflow">return</span> ih-&gt;<a class="code" href="class_s_p38_1_1_intersection_history.html#beb1ef5110ff6e32f6d5d95c30491661">getPhaseMaxDetectorThroughputBetween</a>(p, from, to);
<a name="l00296"></a>00296   }
<a name="l00297"></a>00297 
<a name="l00298"></a>00298   
<a name="l00303"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#3d783ac7a630d8366fe9be25137795e1">00303</a>   <span class="keywordtype">double</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#3d783ac7a630d8366fe9be25137795e1">SP38Simulation::getIntersectionMaxThroughput</a>(<a class="code" href="class_s_p38_1_1_intersection.html">Intersection</a>* <a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a>){
<a name="l00304"></a>00304     <a class="code" href="class_s_p38_1_1_intersection_history.html">IntersectionHistory</a>* ih = scenario_history-&gt;<a class="code" href="class_s_p38_1_1_scenario_history.html#b4f71a36ad11805bf324b7205b3bc283">getIntersectionHistory</a>(i);
<a name="l00305"></a>00305     <span class="keywordflow">return</span> ih-&gt;<a class="code" href="class_s_p38_1_1_intersection_history.html#eb1a6080498b0bb30d019412f10d9d97">getMaxThroughput</a>();
<a name="l00306"></a>00306   }
<a name="l00307"></a>00307 
<a name="l00308"></a>00308 
<a name="l00314"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#5e03ef1ed4d1e823113eccab8cd8b229">00314</a>   <span class="keywordtype">int</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#5e03ef1ed4d1e823113eccab8cd8b229">SP38Simulation::getDetectorCountInCurrentCycle</a>(<a class="code" href="class_s_p38_1_1_intersection.html">Intersection</a>* <a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a>, <a class="code" href="class_s_p38_1_1_detector.html">Detector</a>* d){
<a name="l00315"></a>00315     <span class="keywordflow">return</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#dc5266cb2f5f693170fecaf324fa84ce">getDetectorCountBetween</a>(i,d,(<span class="keywordtype">double</span>)<a class="code" href="class_s_p38_1_1_s_p38_simulation.html#c4bbae7669b72caab73cb44c64db6ae5">getCurrentCycleStartingTime</a>(),(<span class="keywordtype">double</span>)current_time);
<a name="l00316"></a>00316   }
<a name="l00317"></a>00317 
<a name="l00325"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#dc5266cb2f5f693170fecaf324fa84ce">00325</a>   <span class="keywordtype">int</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#dc5266cb2f5f693170fecaf324fa84ce">SP38Simulation::getDetectorCountBetween</a>(<a class="code" href="class_s_p38_1_1_intersection.html">Intersection</a>* <a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a>, <a class="code" href="class_s_p38_1_1_detector.html">Detector</a>* d, <span class="keywordtype">double</span> from, <span class="keywordtype">double</span> to){
<a name="l00326"></a>00326     <a class="code" href="class_s_p38_1_1_intersection_history.html">IntersectionHistory</a>* ih = scenario_history-&gt;<a class="code" href="class_s_p38_1_1_scenario_history.html#b4f71a36ad11805bf324b7205b3bc283">getIntersectionHistory</a>(i);
<a name="l00327"></a>00327     <a class="code" href="class_s_p38_1_1_detector_history.html">DetectorHistory</a>* dh = ih-&gt;<a class="code" href="class_s_p38_1_1_intersection_history.html#4336b432932ce01a420be3a7c2d5b32b">getDetectorHistory</a>(d);
<a name="l00328"></a>00328     <span class="keywordflow">return</span> dh-&gt;<a class="code" href="class_s_p38_1_1_detector_history.html#7a5931465c1dd95b0d92af499f519504">totalActivations</a>(from,to);
<a name="l00329"></a>00329   }
<a name="l00330"></a>00330   
<a name="l00336"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#be4383bc2720dd37f6741f2c52a57839">00336</a>   <span class="keywordtype">int</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#be4383bc2720dd37f6741f2c52a57839">SP38Simulation::getDetectorMaxThroughput</a>(<a class="code" href="class_s_p38_1_1_intersection.html">Intersection</a>* <a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a>, <a class="code" href="class_s_p38_1_1_detector.html">Detector</a>* d){
<a name="l00337"></a>00337     <a class="code" href="class_s_p38_1_1_intersection_history.html">IntersectionHistory</a>* ih = scenario_history-&gt;<a class="code" href="class_s_p38_1_1_scenario_history.html#b4f71a36ad11805bf324b7205b3bc283">getIntersectionHistory</a>(i);
<a name="l00338"></a>00338     <a class="code" href="class_s_p38_1_1_detector_history.html">DetectorHistory</a>* dh = ih-&gt;<a class="code" href="class_s_p38_1_1_intersection_history.html#4336b432932ce01a420be3a7c2d5b32b">getDetectorHistory</a>(d);
<a name="l00339"></a>00339     <span class="keywordflow">return</span> dh-&gt;<a class="code" href="class_s_p38_1_1_detector_history.html#8e7d1488fb8b6617e87a1086653158f4">getMaxActivationsInInterval</a>();
<a name="l00340"></a>00340   }
<a name="l00341"></a>00341 
<a name="l00347"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#b30c5ee524996b7d5bb890adf930f0a1">00347</a>   <span class="keywordtype">void</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#b30c5ee524996b7d5bb890adf930f0a1">SP38Simulation::setNewPhase</a>(<a class="code" href="class_s_p38_1_1_intersection.html">Intersection</a>* <a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a>,<a class="code" href="class_s_p38_1_1_phase.html">Phase</a>* p){
<a name="l00348"></a>00348     <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#b30c5ee524996b7d5bb890adf930f0a1">setNewPhase</a>(<a class="code" href="class_s_p38_1_1_s_p38_simulation.html#1db2d5ca8cffc9045c38c879cf1bdb17">getCurrentTime</a>(),i,p);
<a name="l00349"></a>00349   }
<a name="l00350"></a>00350 
<a name="l00357"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#0b1f80e59b68dc346029dccb1453995d">00357</a>   <span class="keywordtype">void</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#b30c5ee524996b7d5bb890adf930f0a1">SP38Simulation::setNewPhase</a>(<span class="keywordtype">int</span> time,<a class="code" href="class_s_p38_1_1_intersection.html">Intersection</a>* <a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a>,<a class="code" href="class_s_p38_1_1_phase.html">Phase</a>* p){
<a name="l00358"></a>00358 
<a name="l00359"></a>00359     <span class="comment">// If any phase was active before, then must wait</span>
<a name="l00360"></a>00360     <a class="code" href="class_s_p38_1_1_intersection_history.html">IntersectionHistory</a>* ih = scenario_history-&gt;<a class="code" href="class_s_p38_1_1_scenario_history.html#b4f71a36ad11805bf324b7205b3bc283">getIntersectionHistory</a>(i);
<a name="l00361"></a>00361     <a class="code" href="class_s_p38_1_1_phase.html">Phase</a>* pc = ih-&gt;<a class="code" href="class_s_p38_1_1_intersection_history.html#b65239ce370cb54bdc371bb5743a08ca">getPhase</a>(time);
<a name="l00362"></a>00362 
<a name="l00363"></a>00363     <span class="keywordtype">int</span> red_delay = i-&gt;<a class="code" href="class_s_p38_1_1_intersection.html#a7282ba6b060dfaf46be1505088bf19b">getYellowDuration</a>();
<a name="l00364"></a>00364     <span class="keywordtype">int</span> green_delay = pc == NULL ? 0 : red_delay + i-&gt;<a class="code" href="class_s_p38_1_1_intersection.html#cd5872a81da2408e02d60788da0dea89">getInterGreenInterval</a>();
<a name="l00365"></a>00365     
<a name="l00366"></a>00366     <span class="comment">// Ignores changes if something is already scheduled for the schedule times (yellow, green, red)</span>
<a name="l00367"></a>00367     <span class="keywordflow">if</span>(<a class="code" href="class_s_p38_1_1_s_p38_simulation.html#a67f84074aae53c3038e858bb90357de">isAnythingScheduled</a>(i,time) || <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#a67f84074aae53c3038e858bb90357de">isAnythingScheduled</a>(i,time+green_delay) || <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#a67f84074aae53c3038e858bb90357de">isAnythingScheduled</a>(i,time+red_delay) ){
<a name="l00368"></a>00368       <a class="code" href="class_s_p38_1_1_phase_history.html">PhaseHistory</a>* ph = ih-&gt;<a class="code" href="class_s_p38_1_1_intersection_history.html#f7f89fcd6d2853b0e1dccd54d5f32ed7">getPhaseHistory</a>(p);
<a name="l00369"></a>00369       <span class="keywordflow">if</span>(debug){
<a name="l00370"></a>00370         cout &lt;&lt; <span class="stringliteral">" Changing phase "</span> &lt;&lt; p-&gt;<a class="code" href="class_s_p38_1_1_phase.html#1adfdcc102ff4d9934dafd0642a3d05e">getId</a>() &lt;&lt; <span class="stringliteral">" last active "</span> &lt;&lt; ph-&gt;<a class="code" href="class_s_p38_1_1_phase_history.html#c67100999fb10808f780396929dabe05">lastActivation</a>() &lt;&lt; <span class="stringliteral">" on "</span> &lt;&lt; time &lt;&lt; <span class="stringliteral">" at Inter. "</span> &lt;&lt; i-&gt;<a class="code" href="class_s_p38_1_1_intersection.html#2811672ab5ab74be871eea666b44cac3">getId</a>() &lt;&lt; <span class="stringliteral">" ignored... have schedule: "</span> ;
<a name="l00371"></a>00371         <span class="keywordflow">for</span>(ScheduleSet::iterator si = schedule.begin(); si != schedule.end(); si++){
<a name="l00372"></a>00372           <span class="keywordflow">if</span>( (*si)-&gt;getIntersection() == i)
<a name="l00373"></a>00373             cout &lt;&lt; (*si)-&gt;getScheduledTime() &lt;&lt; <span class="stringliteral">" "</span>;
<a name="l00374"></a>00374         }
<a name="l00375"></a>00375         cout &lt;&lt; endl;      
<a name="l00376"></a>00376       }
<a name="l00377"></a>00377       <span class="keywordflow">return</span>;
<a name="l00378"></a>00378     }
<a name="l00379"></a>00379 
<a name="l00380"></a>00380     <span class="keywordflow">if</span>(debug)
<a name="l00381"></a>00381       cout &lt;&lt; <span class="stringliteral">"CH "</span> &lt;&lt; time &lt;&lt; <span class="stringliteral">": Intersection "</span> &lt;&lt; i-&gt;<a class="code" href="class_s_p38_1_1_scats_object.html#2402c5e00fb562d1067a171a47d2608b">getScatsId</a>() &lt;&lt; <span class="stringliteral">" Old Phase "</span> &lt;&lt; ( pc == NULL ? <span class="stringliteral">"no"</span> : pc-&gt;<a class="code" href="class_s_p38_1_1_phase.html#1adfdcc102ff4d9934dafd0642a3d05e">getId</a>()) &lt;&lt; <span class="stringliteral">" New Phase "</span> &lt;&lt; p-&gt;<a class="code" href="class_s_p38_1_1_phase.html#1adfdcc102ff4d9934dafd0642a3d05e">getId</a>() &lt;&lt; endl;
<a name="l00382"></a>00382 
<a name="l00383"></a>00383 
<a name="l00384"></a>00384     <span class="comment">// Phases green changes</span>
<a name="l00385"></a>00385     <a class="code" href="namespace_s_p38.html#1ad3927bf590367e75028be7684be767">SignalGroupChangeSet</a> sgcs_green;
<a name="l00386"></a>00386     <span class="comment">// If no current phase or differente phase, send new phase on</span>
<a name="l00387"></a>00387     <span class="keywordflow">if</span>(pc == NULL || pc != p){
<a name="l00388"></a>00388       <a class="code" href="class_s_p38_1_1_phase_history.html">PhaseHistory</a>* ph = ih-&gt;<a class="code" href="class_s_p38_1_1_intersection_history.html#f7f89fcd6d2853b0e1dccd54d5f32ed7">getPhaseHistory</a>(p);
<a name="l00389"></a>00389       <span class="comment">// Refreshing history</span>
<a name="l00390"></a>00390       ph-&gt;<a class="code" href="class_s_p38_1_1_phase_history.html#89a9003fb0cdda6f395fd8d18a7fd28e">activate</a>(time+green_delay);
<a name="l00391"></a>00391       <span class="comment">// Adding signal group changes to schedule</span>
<a name="l00392"></a>00392       <span class="keywordflow">if</span>(debug) cout &lt;&lt; <span class="stringliteral">"--Green: "</span>;
<a name="l00393"></a>00393       <span class="keywordflow">for</span>(SignalGroupSet::iterator sg = p-&gt;<a class="code" href="class_s_p38_1_1_phase.html#9c1fe18b4e27f3dd8fe0e86f0b6f17e1">signal_groups</a>.begin(); sg !=  p-&gt;<a class="code" href="class_s_p38_1_1_phase.html#9c1fe18b4e27f3dd8fe0e86f0b6f17e1">signal_groups</a>.end(); sg++)
<a name="l00394"></a>00394         <span class="comment">// Don't send signal group on if it's already on</span>
<a name="l00395"></a>00395         <span class="keywordflow">if</span>(pc == NULL || pc-&gt;<a class="code" href="class_s_p38_1_1_phase.html#d06e3d8dcfd46b1f43faadc257ff79b8">getSignalGroup</a>( (*sg)-&gt;getScatsId() ) == NULL){ 
<a name="l00396"></a>00396           <span class="keywordflow">if</span>(debug) cout &lt;&lt; (*sg)-&gt;getScatsId() &lt;&lt; <span class="stringliteral">" "</span>;
<a name="l00397"></a>00397           sgcs_green.push_back(<span class="keyword">new</span> <a class="code" href="class_s_p38_1_1_signal_group_change.html">SignalGroupChange</a>(i, *sg, <a class="code" href="_s_p38_interface_8hh.html#09dbd12301cb814437eb002a3f41841b">GREEN_SIGNAL_SP38</a>));
<a name="l00398"></a>00398         }
<a name="l00399"></a>00399       <span class="comment">// OH GOD NO! HARD CODE!!! REMOVE IT!!!</span>
<a name="l00400"></a>00400       <span class="keywordflow">if</span>( i-&gt;<a class="code" href="class_s_p38_1_1_scats_object.html#2402c5e00fb562d1067a171a47d2608b">getScatsId</a>() == 300 &amp;&amp;   p-&gt;<a class="code" href="class_s_p38_1_1_phase.html#1adfdcc102ff4d9934dafd0642a3d05e">getId</a>() ==<span class="stringliteral">"D"</span> ){       
<a name="l00401"></a>00401         sgcs_green.push_back(<span class="keyword">new</span> <a class="code" href="class_s_p38_1_1_signal_group_change.html">SignalGroupChange</a>(i, i-&gt;<a class="code" href="class_s_p38_1_1_intersection.html#22a07ab4cd4d28b1079ae45a1a225af8">getPhase</a>(<span class="stringliteral">"E"</span>)-&gt;<a class="code" href="class_s_p38_1_1_phase.html#d06e3d8dcfd46b1f43faadc257ff79b8">getSignalGroup</a>(6), <a class="code" href="_s_p38_interface_8hh.html#3512e8b04e6b3c0cdfb399076fdfc956">SIGNAL_OFF_SP38</a>));
<a name="l00402"></a>00402         sgcs_green.push_back(<span class="keyword">new</span> <a class="code" href="class_s_p38_1_1_signal_group_change.html">SignalGroupChange</a>(i, i-&gt;<a class="code" href="class_s_p38_1_1_intersection.html#22a07ab4cd4d28b1079ae45a1a225af8">getPhase</a>(<span class="stringliteral">"E"</span>)-&gt;<a class="code" href="class_s_p38_1_1_phase.html#d06e3d8dcfd46b1f43faadc257ff79b8">getSignalGroup</a>(7), <a class="code" href="_s_p38_interface_8hh.html#3512e8b04e6b3c0cdfb399076fdfc956">SIGNAL_OFF_SP38</a>));
<a name="l00403"></a>00403       }
<a name="l00404"></a>00404 
<a name="l00405"></a>00405       <span class="keywordflow">if</span>(debug) cout &lt;&lt; endl;
<a name="l00406"></a>00406       
<a name="l00407"></a>00407     }
<a name="l00408"></a>00408 
<a name="l00409"></a>00409     <span class="comment">// If changed the phase, refresh history, send phase off</span>
<a name="l00410"></a>00410     <span class="comment">// Phases yellow and red changes</span>
<a name="l00411"></a>00411     <a class="code" href="namespace_s_p38.html#1ad3927bf590367e75028be7684be767">SignalGroupChangeSet</a> sgcs_yellow;
<a name="l00412"></a>00412     <a class="code" href="namespace_s_p38.html#1ad3927bf590367e75028be7684be767">SignalGroupChangeSet</a> sgcs_red;
<a name="l00413"></a>00413     <span class="keywordflow">if</span>( pc != NULL &amp;&amp; pc != p ){
<a name="l00414"></a>00414       <a class="code" href="class_s_p38_1_1_phase_history.html">PhaseHistory</a>* phc = ih-&gt;<a class="code" href="class_s_p38_1_1_intersection_history.html#f7f89fcd6d2853b0e1dccd54d5f32ed7">getPhaseHistory</a>(pc);     
<a name="l00415"></a>00415       
<a name="l00416"></a>00416       <span class="comment">// Refreshing history</span>
<a name="l00417"></a>00417       <span class="comment">// The inter green time goes to the last activated phase...</span>
<a name="l00418"></a>00418       phc-&gt;<a class="code" href="class_s_p38_1_1_phase_history.html#f19280a4626e34ecb346b88a35e89b2c">deactivate</a>(time+green_delay);
<a name="l00419"></a>00419       <span class="keywordflow">if</span>(debug) cout &lt;&lt; <span class="stringliteral">"--Yellow: "</span>;
<a name="l00420"></a>00420       <span class="keywordflow">for</span>(SignalGroupSet::iterator sg = pc-&gt;<a class="code" href="class_s_p38_1_1_phase.html#9c1fe18b4e27f3dd8fe0e86f0b6f17e1">signal_groups</a>.begin(); sg !=  pc-&gt;<a class="code" href="class_s_p38_1_1_phase.html#9c1fe18b4e27f3dd8fe0e86f0b6f17e1">signal_groups</a>.end(); sg++)
<a name="l00421"></a>00421         <span class="comment">// Don't send signal group off if it's both phases</span>
<a name="l00422"></a>00422         <span class="keywordflow">if</span>( p-&gt;<a class="code" href="class_s_p38_1_1_phase.html#d06e3d8dcfd46b1f43faadc257ff79b8">getSignalGroup</a>( (*sg)-&gt;getScatsId() ) == NULL){
<a name="l00423"></a>00423           <span class="keywordflow">if</span>(debug) cout &lt;&lt; (*sg)-&gt;getScatsId() &lt;&lt; <span class="stringliteral">" "</span>;
<a name="l00424"></a>00424           sgcs_yellow.push_back(<span class="keyword">new</span> <a class="code" href="class_s_p38_1_1_signal_group_change.html">SignalGroupChange</a>(i, *sg, <a class="code" href="_s_p38_interface_8hh.html#c0afd16eebe4b2d2687bfa43d64cac18">YELLOW_SIGNAL_SP38</a>));
<a name="l00425"></a>00425         }
<a name="l00426"></a>00426       
<a name="l00427"></a>00427       <span class="keywordflow">if</span>(debug) cout &lt;&lt; endl &lt;&lt; <span class="stringliteral">"--Red: "</span>;
<a name="l00428"></a>00428       <span class="keywordflow">for</span>(SignalGroupSet::iterator sg = pc-&gt;<a class="code" href="class_s_p38_1_1_phase.html#9c1fe18b4e27f3dd8fe0e86f0b6f17e1">signal_groups</a>.begin(); sg !=  pc-&gt;<a class="code" href="class_s_p38_1_1_phase.html#9c1fe18b4e27f3dd8fe0e86f0b6f17e1">signal_groups</a>.end(); sg++)
<a name="l00429"></a>00429         <span class="comment">// Don't send signal group off if it's both phases</span>
<a name="l00430"></a>00430         <span class="keywordflow">if</span>( p-&gt;<a class="code" href="class_s_p38_1_1_phase.html#d06e3d8dcfd46b1f43faadc257ff79b8">getSignalGroup</a>( (*sg)-&gt;getScatsId() ) == NULL){
<a name="l00431"></a>00431           <span class="keywordflow">if</span>(debug) cout &lt;&lt; (*sg)-&gt;getScatsId() &lt;&lt; <span class="stringliteral">" "</span>;
<a name="l00432"></a>00432           sgcs_red.push_back(<span class="keyword">new</span> <a class="code" href="class_s_p38_1_1_signal_group_change.html">SignalGroupChange</a>(i, *sg, <a class="code" href="_s_p38_interface_8hh.html#0df87df96efdd6340630f259c9854c87">RED_SIGNAL_SP38</a>));
<a name="l00433"></a>00433         }
<a name="l00434"></a>00434       <span class="keywordflow">if</span>(debug) cout &lt;&lt; endl;      
<a name="l00435"></a>00435     }
<a name="l00436"></a>00436 
<a name="l00437"></a>00437     <span class="comment">// If any changes to intersection</span>
<a name="l00438"></a>00438     
<a name="l00439"></a>00439     <span class="keywordflow">if</span>(sgcs_green.size() &gt; 0){
<a name="l00440"></a>00440       addSchedule(<span class="keyword">new</span> <a class="code" href="class_s_p38_1_1_schedule.html">Schedule</a>(time+green_delay,i, sgcs_green));   
<a name="l00441"></a>00441       <span class="comment">// If a phase turned green then it must satisfy minimal green time constraint      </span>
<a name="l00442"></a>00442       <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#9fde66cdac477eb97130cf556b3dfb9f">setNoChangesBetween</a>(i, time+green_delay, time+green_delay+i-&gt;<a class="code" href="class_s_p38_1_1_intersection.html#813eb3548af5c7104de7052e38a63d88">getMinimumGreenDuration</a>());
<a name="l00443"></a>00443     }
<a name="l00444"></a>00444     <span class="comment">// As you will have the same signals in the yellow and red set</span>
<a name="l00445"></a>00445     <span class="comment">// Then if by some chance you set the signals to yellow at the same time or after</span>
<a name="l00446"></a>00446     <span class="comment">// you set them red... then won't set the yellow signals</span>
<a name="l00447"></a>00447     <span class="keywordflow">if</span>(sgcs_yellow.size() &gt; 0 &amp;&amp; time &lt; time+red_delay){
<a name="l00448"></a>00448       addSchedule(<span class="keyword">new</span> <a class="code" href="class_s_p38_1_1_schedule.html">Schedule</a>(time,i, sgcs_yellow));   
<a name="l00449"></a>00449       <span class="comment">// A phase must remains yellow until it turns red</span>
<a name="l00450"></a>00450       <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#9fde66cdac477eb97130cf556b3dfb9f">setNoChangesBetween</a>(i, time, time+red_delay);
<a name="l00451"></a>00451     }
<a name="l00452"></a>00452     <span class="keywordflow">if</span>(sgcs_red.size() &gt; 0){
<a name="l00453"></a>00453       addSchedule(<span class="keyword">new</span> <a class="code" href="class_s_p38_1_1_schedule.html">Schedule</a>(time+red_delay,i, sgcs_red));   
<a name="l00454"></a>00454       <span class="comment">// Every phase must remains red for some seconds until one turns green</span>
<a name="l00455"></a>00455       <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#9fde66cdac477eb97130cf556b3dfb9f">setNoChangesBetween</a>(i, time+red_delay, time+green_delay);
<a name="l00456"></a>00456     }
<a name="l00457"></a>00457     
<a name="l00458"></a>00458   }
<a name="l00459"></a>00459   
<a name="l00467"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#9fde66cdac477eb97130cf556b3dfb9f">00467</a>   <span class="keywordtype">void</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#9fde66cdac477eb97130cf556b3dfb9f">SP38Simulation::setNoChangesBetween</a>(<a class="code" href="class_s_p38_1_1_intersection.html">Intersection</a>* <a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a>, <span class="keywordtype">int</span> start_time, <span class="keywordtype">int</span> end_time){
<a name="l00468"></a>00468 
<a name="l00469"></a>00469     <span class="keywordflow">if</span>(debug) cout &lt;&lt; <span class="stringliteral">"Requesting NO CHANGES Intersec. "</span> &lt;&lt; i-&gt;<a class="code" href="class_s_p38_1_1_intersection.html#2811672ab5ab74be871eea666b44cac3">getId</a>() &lt;&lt; <span class="stringliteral">" ["</span> &lt;&lt; start_time &lt;&lt; <span class="stringliteral">","</span> &lt;&lt; end_time &lt;&lt; <span class="stringliteral">"]: "</span>;
<a name="l00470"></a>00470     <span class="comment">// Setting null schedules for the time between.</span>
<a name="l00471"></a>00471     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> t=<a class="code" href="class_s_p38_1_1_s_p38_simulation.html#6d92c18f2f76d5ad934b0fb197b5bb6e">getNextActionTime</a>(start_time); t &lt; end_time; t = <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#6d92c18f2f76d5ad934b0fb197b5bb6e">getNextActionTime</a>(t)){
<a name="l00472"></a>00472       <span class="keywordflow">if</span>(debug) cout &lt;&lt; t &lt;&lt; <span class="stringliteral">" "</span>;
<a name="l00473"></a>00473       addSchedule(<span class="keyword">new</span> <a class="code" href="class_s_p38_1_1_schedule.html">Schedule</a>(t, i, <a class="code" href="namespace_s_p38.html#1ad3927bf590367e75028be7684be767">SignalGroupChangeSet</a>() ));
<a name="l00474"></a>00474     }
<a name="l00475"></a>00475     <span class="keywordflow">if</span>(debug) cout &lt;&lt; endl;
<a name="l00476"></a>00476   }
<a name="l00477"></a>00477 
<a name="l00478"></a>00478 
<a name="l00479"></a>00479 
<a name="l00484"></a>00484   <span class="keywordtype">void</span> SP38Simulation::forceAllPhasesInCycleConstraint(){
<a name="l00485"></a>00485     <span class="keywordtype">int</span> cycle_size = scenario-&gt;<a class="code" href="class_s_p38_1_1_scenario.html#975956fd39c891d3bee9e9fbec1630ba">getCycleDuration</a>();
<a name="l00486"></a>00486     <span class="keywordtype">int</span> cycle_start = <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#c4bbae7669b72caab73cb44c64db6ae5">getCurrentCycleStartingTime</a>();
<a name="l00487"></a>00487     <span class="keywordtype">int</span> cycle_end = cycle_start + cycle_size;
<a name="l00488"></a>00488     <span class="keywordtype">int</span> current_time =  <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#1db2d5ca8cffc9045c38c879cf1bdb17">getCurrentTime</a>();
<a name="l00489"></a>00489     <span class="keywordtype">int</span> time_left = cycle_end - current_time;
<a name="l00490"></a>00490     
<a name="l00491"></a>00491     <span class="keywordflow">if</span>(debug) cout &lt;&lt; <span class="stringliteral">"Will force all cycle constraints? Current time "</span> &lt;&lt; current_time &lt;&lt; <span class="stringliteral">" Cycle Starts in "</span> &lt;&lt; cycle_start &lt;&lt; <span class="stringliteral">" and ends in "</span> &lt;&lt; cycle_end &lt;&lt; endl;
<a name="l00492"></a>00492 
<a name="l00493"></a>00493     <span class="keywordflow">for</span>(IntersectionSet::iterator ii = scenario-&gt;<a class="code" href="class_s_p38_1_1_scenario.html#ce4f52834a02f040f43167ae7a6f3f2e">intersections</a>.begin(); ii != scenario-&gt;<a class="code" href="class_s_p38_1_1_scenario.html#ce4f52834a02f040f43167ae7a6f3f2e">intersections</a>.end(); ii++){
<a name="l00494"></a>00494       <span class="keywordtype">int</span> activation_time = <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#f769334c37a97aea4d53a2b461dc603f">getMinimalActivationTime</a>(*ii);
<a name="l00495"></a>00495       <a class="code" href="class_s_p38_1_1_intersection_history.html">IntersectionHistory</a>* ih = scenario_history-&gt;<a class="code" href="class_s_p38_1_1_scenario_history.html#b4f71a36ad11805bf324b7205b3bc283">getIntersectionHistory</a>(*ii);
<a name="l00496"></a>00496       <span class="keywordtype">int</span> total_phases = (*ii)-&gt;phases.size();
<a name="l00497"></a>00497       vector &lt;bool&gt; activated( total_phases , <span class="keyword">false</span> );
<a name="l00498"></a>00498       <span class="keywordtype">int</span> total_activated = 0;
<a name="l00499"></a>00499 
<a name="l00500"></a>00500       <span class="comment">// Marking all Phases activations      </span>
<a name="l00501"></a>00501       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> p=0; p &lt; total_phases; p++){
<a name="l00502"></a>00502         <span class="comment">// Getting phase history</span>
<a name="l00503"></a>00503         <a class="code" href="class_s_p38_1_1_phase_history.html">PhaseHistory</a>* ph = ih-&gt;<a class="code" href="class_s_p38_1_1_intersection_history.html#f7f89fcd6d2853b0e1dccd54d5f32ed7">getPhaseHistory</a>((*ii)-&gt;phases[p]);
<a name="l00504"></a>00504         <span class="keywordtype">int</span> total_active_time = ph-&gt;<a class="code" href="class_s_p38_1_1_phase_history.html#5480cc74a7703c4676b8285449ae54b6">totalActiveTime</a>(cycle_start,cycle_end);
<a name="l00505"></a>00505         <span class="comment">// If activated in the current cycle</span>
<a name="l00506"></a>00506         <span class="keywordflow">if</span>( total_active_time &gt; 0 ){
<a name="l00507"></a>00507           activated[p] = <span class="keyword">true</span>;
<a name="l00508"></a>00508           total_activated++;
<a name="l00509"></a>00509         }                   
<a name="l00510"></a>00510       }
<a name="l00511"></a>00511       <span class="comment">// Computing time needed to cycle trough all phases</span>
<a name="l00512"></a>00512       <span class="keywordtype">int</span> time_needed = (total_phases - total_activated)*activation_time;
<a name="l00513"></a>00513 
<a name="l00514"></a>00514       <span class="keywordflow">if</span>(debug){
<a name="l00515"></a>00515         cout &lt;&lt; <span class="stringliteral">"Intersection "</span> &lt;&lt; (*ii)-&gt;getId()  &lt;&lt; <span class="stringliteral">" Time needed "</span> &lt;&lt; time_needed &lt;&lt; <span class="stringliteral">" Time Left "</span> &lt;&lt; time_left &lt;&lt; endl;
<a name="l00516"></a>00516       }
<a name="l00517"></a>00517       assert(time_needed &lt;= time_left);
<a name="l00518"></a>00518 
<a name="l00519"></a>00519       <span class="comment">// If the time needed is almost the time left.. then schedule the phases changes!</span>
<a name="l00520"></a>00520       <span class="comment">// It is important to do this one time step before its too late, because something could already be scheduled</span>
<a name="l00521"></a>00521       <span class="comment">// Because of some yellow and intergreen times plus the activation time of the next phase, you should start it earlier</span>
<a name="l00522"></a>00522       <span class="keywordflow">if</span>( time_needed &gt; 0 &amp;&amp; time_needed &gt;  time_left - activation_time ){
<a name="l00523"></a>00523         <span class="keywordtype">int</span> next_phase_start = cycle_end - time_needed;
<a name="l00524"></a>00524 
<a name="l00525"></a>00525         <span class="comment">// Must avoid new phases between the current time and the enforced phases, or else things will go crazy with scheduled changes</span>
<a name="l00526"></a>00526         <span class="comment">// Must include the current_time...</span>
<a name="l00527"></a>00527         <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#9fde66cdac477eb97130cf556b3dfb9f">setNoChangesBetween</a>(*ii, current_time-1, next_phase_start);
<a name="l00528"></a>00528 
<a name="l00529"></a>00529         <span class="keywordflow">if</span>(debug) cout &lt;&lt; <span class="stringliteral">" FORCING PHASES in INTERSECTION "</span> &lt;&lt; (*ii)-&gt;getScatsId() &lt;&lt; endl;
<a name="l00530"></a>00530         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> p=0; p &lt; total_phases; p++){
<a name="l00531"></a>00531           <span class="keywordflow">if</span>(!activated[p]){        
<a name="l00532"></a>00532             PhaseHistory* ph = ih-&gt;<a class="code" href="class_s_p38_1_1_intersection_history.html#f7f89fcd6d2853b0e1dccd54d5f32ed7">getPhaseHistory</a>((*ii)-&gt;phases[p]);
<a name="l00533"></a>00533             <span class="keywordflow">if</span>(debug) cout &lt;&lt; <span class="stringliteral">"\t"</span> &lt;&lt; (*ii)-&gt;phases[p]-&gt;getId() &lt;&lt; <span class="stringliteral">" at "</span> &lt;&lt; next_phase_start &lt;&lt; <span class="stringliteral">" last activation "</span> &lt;&lt; ph-&gt;lastActivation() &lt;&lt; endl;
<a name="l00534"></a>00534 
<a name="l00535"></a>00535             <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#b30c5ee524996b7d5bb890adf930f0a1">setNewPhase</a>(next_phase_start,(*ii),(*ii)-&gt;phases[p]);
<a name="l00536"></a>00536             next_phase_start += activation_time;
<a name="l00537"></a>00537           }     
<a name="l00538"></a>00538         }       
<a name="l00539"></a>00539         
<a name="l00540"></a>00540 
<a name="l00541"></a>00541       }
<a name="l00542"></a>00542       
<a name="l00543"></a>00543     }
<a name="l00544"></a>00544   }
<a name="l00545"></a>00545 
<a name="l00546"></a>00546 
<a name="l00550"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#1db2d5ca8cffc9045c38c879cf1bdb17">00550</a>   <span class="keywordtype">int</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#1db2d5ca8cffc9045c38c879cf1bdb17">SP38Simulation::getCurrentTime</a>(){
<a name="l00551"></a>00551     <span class="keywordflow">return</span> current_time;
<a name="l00552"></a>00552   }
<a name="l00553"></a>00553 
<a name="l00557"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#e468bf07b712d4cebf389231e9bc6a82">00557</a>   <span class="keywordtype">int</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#e468bf07b712d4cebf389231e9bc6a82">SP38Simulation::getLastRestartTime</a>(){
<a name="l00558"></a>00558     <span class="keywordflow">return</span> last_restart_time;
<a name="l00559"></a>00559   }
<a name="l00560"></a>00560 
<a name="l00561"></a>00561 
<a name="l00565"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#f0158583ef8e6419f47dd2fa991caa1c">00565</a>   <span class="keywordtype">int</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#f0158583ef8e6419f47dd2fa991caa1c">SP38Simulation::getTimeStepSize</a>(){
<a name="l00566"></a>00566     <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)time_step_size;
<a name="l00567"></a>00567   }
<a name="l00568"></a>00568   
<a name="l00569"></a>00569 
<a name="l00576"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#f769334c37a97aea4d53a2b461dc603f">00576</a>   <span class="keywordtype">int</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#f769334c37a97aea4d53a2b461dc603f">SP38Simulation::getMinimalActivationTime</a>(<a class="code" href="class_s_p38_1_1_intersection.html">Intersection</a>* <a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a> ){
<a name="l00577"></a>00577     <span class="keywordflow">return</span> ((<span class="keywordtype">int</span>)(ceil (  ((<span class="keywordtype">double</span>)( i-&gt;<a class="code" href="class_s_p38_1_1_intersection.html#a7282ba6b060dfaf46be1505088bf19b">getYellowDuration</a>() + i-&gt;<a class="code" href="class_s_p38_1_1_intersection.html#cd5872a81da2408e02d60788da0dea89">getInterGreenInterval</a>() + i-&gt;<a class="code" href="class_s_p38_1_1_intersection.html#813eb3548af5c7104de7052e38a63d88">getMinimumGreenDuration</a>() ))
<a name="l00578"></a>00578                           /
<a name="l00579"></a>00579                           (double)time_step_size)))
<a name="l00580"></a>00580             * time_step_size;       
<a name="l00581"></a>00581   }
<a name="l00582"></a>00582 
<a name="l00583"></a>00583 
<a name="l00587"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#c4bbae7669b72caab73cb44c64db6ae5">00587</a>   <span class="keywordtype">int</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#c4bbae7669b72caab73cb44c64db6ae5">SP38Simulation::getCurrentCycleStartingTime</a>(){
<a name="l00588"></a>00588     <span class="keywordflow">return</span> current_time -  <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#ccaefdff0b3a68d524cb19bad46dc507">getCurrentCycleDuration</a>();
<a name="l00589"></a>00589   }
<a name="l00590"></a>00590 
<a name="l00594"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#ccaefdff0b3a68d524cb19bad46dc507">00594</a>   <span class="keywordtype">int</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#ccaefdff0b3a68d524cb19bad46dc507">SP38Simulation::getCurrentCycleDuration</a>(){
<a name="l00595"></a>00595     <span class="keywordflow">return</span> scenario_history-&gt;<a class="code" href="class_s_p38_1_1_scenario_history.html#78441ace0bdd5d40858b009e3e06c269">getCurrentCycleDuration</a>();
<a name="l00596"></a>00596   } 
<a name="l00597"></a>00597 
<a name="l00598"></a>00598 
<a name="l00604"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#6d92c18f2f76d5ad934b0fb197b5bb6e">00604</a>   <span class="keywordtype">int</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#6d92c18f2f76d5ad934b0fb197b5bb6e">SP38Simulation::getNextActionTime</a>(<span class="keywordtype">int</span> time){
<a name="l00605"></a>00605     <span class="keywordflow">return</span> ((time / time_step_size)+1)*time_step_size;
<a name="l00606"></a>00606   }
<a name="l00607"></a>00607 
<a name="l00612"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#af7cd1bc85a3910135a247b2b83b7c93">00612</a>   <span class="keywordtype">void</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#af7cd1bc85a3910135a247b2b83b7c93">SP38Simulation::setDebug</a>(<span class="keywordtype">bool</span> d){
<a name="l00613"></a>00613     debug = d;
<a name="l00614"></a>00614   }
<a name="l00615"></a>00615 
<a name="l00620"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#37e36862ec02b92f75fdf5a750464e3c">00620</a>   <span class="keywordtype">void</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#37e36862ec02b92f75fdf5a750464e3c">SP38Simulation::setNoisy</a>(<span class="keywordtype">bool</span> n){
<a name="l00621"></a>00621     noisy = n;
<a name="l00622"></a>00622   }
<a name="l00623"></a>00623 
<a name="l00624"></a>00624   
<a name="l00628"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#dd56f3ff2bc10fa46b114850c1e99706">00628</a>   <a class="code" href="class_s_p38_1_1_scenario.html">Scenario</a>* <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#dd56f3ff2bc10fa46b114850c1e99706">SP38Simulation::getScenario</a>(){
<a name="l00629"></a>00629     <span class="keywordflow">return</span> scenario;
<a name="l00630"></a>00630   }
<a name="l00631"></a>00631 
<a name="l00636"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#0099dd3ba0045d1332468e94091d480d">00636</a>   <a class="code" href="class_s_p38_1_1_scenario_history.html">ScenarioHistory</a>* <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#0099dd3ba0045d1332468e94091d480d">SP38Simulation::getCurrentScenarioHistory</a>(){
<a name="l00637"></a>00637     <span class="keywordflow">return</span> scenario_history;
<a name="l00638"></a>00638   }
<a name="l00639"></a>00639 
<a name="l00640"></a>00640 
<a name="l00646"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#f67a7af137025bc2cfc307490507096c">00646</a>   <span class="keywordtype">bool</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#f67a7af137025bc2cfc307490507096c">SP38Simulation::isDetectorActive</a>(<a class="code" href="class_s_p38_1_1_intersection.html">Intersection</a>* <a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a>, <a class="code" href="class_s_p38_1_1_detector.html">Detector</a>* d){
<a name="l00647"></a>00647     <a class="code" href="class_s_p38_1_1_intersection_history.html">IntersectionHistory</a>* ih = scenario_history-&gt;<a class="code" href="class_s_p38_1_1_scenario_history.html#b4f71a36ad11805bf324b7205b3bc283">getIntersectionHistory</a>(i);
<a name="l00648"></a>00648     <a class="code" href="class_s_p38_1_1_detector_history.html">DetectorHistory</a>* dh = ih-&gt;<a class="code" href="class_s_p38_1_1_intersection_history.html#4336b432932ce01a420be3a7c2d5b32b">getDetectorHistory</a>(d);
<a name="l00649"></a>00649     <span class="keywordflow">return</span> dh-&gt;<a class="code" href="class_s_p38_1_1_detector_history.html#6fceb809603e73fa6aa256e5e1c7e63d">isActive</a>();    
<a name="l00650"></a>00650   }
<a name="l00651"></a>00651 
<a name="l00657"></a><a class="code" href="class_s_p38_1_1_s_p38_simulation.html#a67f84074aae53c3038e858bb90357de">00657</a>   <span class="keywordtype">bool</span> <a class="code" href="class_s_p38_1_1_s_p38_simulation.html#a67f84074aae53c3038e858bb90357de">SP38Simulation::isAnythingScheduled</a>(<a class="code" href="class_s_p38_1_1_intersection.html">Intersection</a>* <a class="code" href="namespacesum_and_plot.html#97610daaf345ca7fdc1c39359036529e">i</a>,<span class="keywordtype">int</span> time){
<a name="l00658"></a>00658     <span class="keywordflow">for</span>(ScheduleSet::iterator si = schedule.begin(); si != schedule.end(); si++)
<a name="l00659"></a>00659       <span class="keywordflow">if</span>( (*si)-&gt;getIntersection() == i &amp;&amp; (*si)-&gt;getScheduledTime() == time ) <span class="keywordflow">return</span> <span class="keyword">true</span>;      
<a name="l00660"></a>00660     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00661"></a>00661   }
<a name="l00662"></a>00662 
<a name="l00668"></a>00668   <a class="code" href="namespace_s_p38.html#9a0b9534bc4e34b3bf4bcf849e6849d3">ScheduleSet</a> SP38Simulation::getCurrentSchedule(<span class="keywordtype">int</span> time){
<a name="l00669"></a>00669     <a class="code" href="namespace_s_p38.html#9a0b9534bc4e34b3bf4bcf849e6849d3">ScheduleSet</a> time_schedule;
<a name="l00670"></a>00670     <span class="keywordflow">for</span>(ScheduleSet::iterator si = schedule.begin(); si != schedule.end(); si++)
<a name="l00671"></a>00671       <span class="keywordflow">if</span>( (*si)-&gt;getScheduledTime() == time ){
<a name="l00672"></a>00672         time_schedule.push_back(*si);
<a name="l00673"></a>00673         schedule.erase(si);
<a name="l00674"></a>00674         si--;
<a name="l00675"></a>00675       }
<a name="l00676"></a>00676     <span class="keywordflow">return</span> time_schedule;
<a name="l00677"></a>00677   }
<a name="l00678"></a>00678 
<a name="l00684"></a>00684   <span class="keywordtype">void</span> SP38Simulation::addSchedule(Schedule* <a class="code" href="namespacesum_and_plot.html#603763aecd0551b8cd9fc4892c55fd3f">s</a>){
<a name="l00685"></a>00685     ScheduleSet::iterator pos = schedule.end();
<a name="l00686"></a>00686     <span class="keywordflow">for</span>(ScheduleSet::iterator si = schedule.begin(); si != schedule.end(); si++)
<a name="l00687"></a>00687       <span class="keywordflow">if</span>( s-&gt;getScheduledTime() &lt; (*si)-&gt;getScheduledTime() ){
<a name="l00688"></a>00688         pos = si;
<a name="l00689"></a>00689         <span class="keywordflow">break</span>;
<a name="l00690"></a>00690       }
<a name="l00691"></a>00691     schedule.insert(pos, s);
<a name="l00692"></a>00692   }
<a name="l00693"></a>00693 
<a name="l00698"></a>00698   <span class="keywordtype">void</span> SP38Simulation::clearScheduleSet(<a class="code" href="namespace_s_p38.html#9a0b9534bc4e34b3bf4bcf849e6849d3">ScheduleSet</a> ss){
<a name="l00699"></a>00699     <span class="keywordflow">for</span>(ScheduleSet::iterator si = ss.begin(); si != ss.end(); si++)
<a name="l00700"></a>00700       <span class="keyword">delete</span> (*si);
<a name="l00701"></a>00701     ss.clear();
<a name="l00702"></a>00702   }
<a name="l00703"></a>00703 
<a name="l00708"></a>00708   <span class="keywordtype">void</span> SP38Simulation::clearEventSet(<a class="code" href="namespace_s_p38.html#c4c9a0677ba5f336332244bccf46fd2b">EventSet</a> es){
<a name="l00709"></a>00709     <span class="keywordflow">for</span>(EventSet::iterator ei = es.begin(); ei != es.end(); ei++)
<a name="l00710"></a>00710       <span class="keyword">delete</span> (*ei);
<a name="l00711"></a>00711     es.clear();
<a name="l00712"></a>00712   }  
<a name="l00713"></a>00713 
<a name="l00714"></a>00714 }
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Mon Sep 10 19:32:09 2007 for The PG Library by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.3 </small></address>
</body>
</html>
